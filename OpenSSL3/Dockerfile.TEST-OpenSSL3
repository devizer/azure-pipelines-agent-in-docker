ARG BASE_IMAGE=debian:jessie
FROM ${BASE_IMAGE}

ENV DEBIAN_PACKAGES="wget"
ENV ALPINE_PACKAGES="bash wget libstdc++"

ARG BASE_IMAGE
RUN echo "Building on image: ${BASE_IMAGE}"
RUN if [ -n "$(command -v apk)" ]; then apk update; apk update || apk update || apk update; cmd="apk add $ALPINE_PACKAGES"; eval $cmd || eval $cmd || eval $cmd; fi

WORKDIR /Work
COPY . .
SHELL ["/bin/bash", "-eu", "-o", "pipefail", "-c"]

RUN bash install-build-tools-bundle.sh; bash Install-DevOps-Library.sh; Repair-Legacy-OS-Sources
RUN if [[ -n "$(command -v apt-get)" ]]; then try-and-retry apt-get install $DEBIAN_PACKAGES -qq; fi

RUN Say "Installing .NET Dependencies"; Run-Remote-Script https://devizer.github.io/devops-library/install-dotnet-dependencies.sh
RUN Say "Deleting openssl"; \
   if [[ -n "$(command -v apt-get)" ]]; then for p in libssl1.0.2 libssl1.1 libssl1.0.0 openssl; do apt-get purge $p 2>&1 | { grep Removing || true; } || true; done; Say "SSL DEBIAN PACKAGES"; list-packages | grep ssl || true; fi; \
   if [[ -n "$(command -v apk)" ]]; then for p in openssl libcrypto3 libssl3 libcrypto1.1 libssl1.1 libcrypto1.0 libssl1.0 openssl; do apk del $p ; done; fi;


RUN \
  Say "Get-NET-RID - [$(Get-NET-RID)]"; \
  Say "Get-Linux-OS-ID - [$(Get-Linux-OS-ID)]"; \
  Say "Get-Linux-OS-Architecture - [$(Get-Linux-OS-Architecture)]"


CMD ["bash"]
